{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/msoa.js","webpack:///./src/start.js","webpack:///./src/map.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","msoa","handleLocation","getQueryString","startMap","config","long","lat","zoom","csrf","map","createMap","createApp","run","window","acceptform","document","getElementById","acceptbutton","navigator","geolocation","getCurrentPosition","position","coords","longitude","toFixed","latitude","innerHTML","error","code","PERMISSION_DENIED","maximumAge","param","v","location","search","substring","split","length","createClickHandler","app","createMessage","createMessageFactory","e","feature","queryRenderedFeatures","point","layers","undefined","clickedCode","properties","msoa11cd","hasSelection","selection","getCode","removeSelection","setSelection","coordinates","this","getName","msoa11hclnm","open","setPaintProperty","mapboxgl","Popup","closeButton","setLngLat","setDOMContent","addTo","on","close","remove","deselect","createSelection","lngLat","closeHandler","closeAndRemoveSelection","html","msoa11nm","msoanamesVersion","message","createElement","className","getElementsByClassName","addEventListener","getFloatParam","val","defVal","isNaN","parseFloat","zoomLevel","accessToken","mapboxAccessToken","Map","container","style","mapboxStyleUrl","center","addControl","NavigationControl","getCanvas","cursor","addSource","mapboxSourceUrl","addLayer","mapboxSourceName","getZoom","getCenter","z","url","lng","history","replaceState","getSelection","getCSRF"],"mappings":"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","file":"msoa.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","import { handleLocation, getQueryString } from \"./start.js\";\nimport { createMap , createApp } from \"./map.js\";\n\nconst msoa = {};\nmsoa.handleLocation = handleLocation;\nmsoa.getQueryString = getQueryString;\nmsoa.startMap = (config, long, lat, zoom, csrf) => {\n    const map = createMap(config, long, lat, zoom);\n    const app = createApp(config, map, csrf);\n    app.run();\n};\n\nwindow.msoa = msoa;\n","// Handle start-up -----------------------------------------------------------\n\nconst handleLocation = () => {\n    const acceptform = document.getElementById(\"acceptform\");\n    const acceptbutton = document.getElementById(\"acceptbutton\");\n    if (\"geolocation\" in navigator) {\n        navigator.geolocation.getCurrentPosition(\n            (position) => {\n                acceptform.long.value = position.coords.longitude.toFixed(6);\n                acceptform.lat.value = position.coords.latitude.toFixed(6);\n                acceptbutton.innerHTML = \"See MSOAs near me\";\n            },\n            (error) => {\n                if (error.code == error.PERMISSION_DENIED) {\n                    acceptbutton.innerHTML = \"See a map of MSOAs\";\n                }\n            },\n            { maximumAge: 300000 }\n        );\n    }\n};\n\nconst getQueryString = (param) => {\n    const qs = window.location.search.substring(1);\n    const v = qs.split(\"&\");\n    for (let i = 0; i < v.length; i++) {\n        const p = v[i].split(\"=\");\n        if (p[\"0\"] == param) return p[\"1\"];\n    }\n    return null;\n};\n\n// Exports -------------------------------------------------------------------\nexport { handleLocation, getQueryString };\n","/* global mapboxgl */\n\n// Factories -----------------------------------------------------------------\nconst createMap = (config, long, lat, zoom) => {\n\n    // Check the parameters are sane and set to defaults if not\n    const getFloatParam = (val, defVal) => {\n        if (val == null || val == false || isNaN(parseFloat(val))) {\n            return defVal;\n        } else {\n            return parseFloat(val);\n        }\n    };\n\n    const longitude = getFloatParam(long, -0.116773);\n    const latitude = getFloatParam(lat, 51.510356);\n    const zoomLevel = getFloatParam(zoom, 12.5);\n\n    mapboxgl.accessToken = config.mapboxAccessToken;\n\n    const map = new mapboxgl.Map({\n        container: \"map\",\n        style: config.mapboxStyleUrl, \n        center: [longitude, latitude],\n        zoom: zoomLevel\n    });\n\n    return map;\n};\n\nconst createApp = (config, map, csrf) => ({\n\n    selection: null,\n    config: config,\n    map: map,\n    csrf: csrf,\n\n    run() {\n\n        // Set up the map\n        map.addControl(new mapboxgl.NavigationControl(), \"top-right\");\n\n        // map.addControl(new mapboxgl.GeolocateControl({\n        //     showUserLocation: false,\n        //     fitBoundsOptions: {maxZoom: 12.5}\n        // }));\n\n        map.getCanvas().style.cursor = \"pointer\";\n\n        this.map.on(\"load\", () => {\n\n            map.addSource(\"msoa\", {\n                \"type\": \"vector\",\n                \"url\": config.mapboxSourceUrl\n            });\n\n            map.addLayer({\n                \"id\": \"msoa-highlight\",\n                \"type\": \"fill\",\n                \"source\": \"msoa\",\n                \"source-layer\": config.mapboxSourceName,\n                \"paint\": {\n                    \"fill-color\": \"#682f7f\",\n                    \"fill-opacity\": 0\n                },\n                \"minzoom\": 8.5,\n                \"maxzoom\": 22\n            });\n        });\n\n        // Click-handler in now disabled\n        map.on(\"click\", createClickHandler(this));\n\n        // Remove any open selection when the map zooms out too far\n        map.on(\"zoom\", () => {\n            if (map.getZoom() < 8.5 && this.hasSelection()) {\n                this.closeAndRemoveSelection();\n            }\n        });\n\n        // Update the query string with the current map position\n        map.on(\"moveend\", () => {\n            const c = map.getCenter();\n            const z = map.getZoom();\n            const url = `/msoanames/map?long=${c.lng}&lat=${c.lat}&zoom=${z}`;\n            history.replaceState(null, null, url);\n        });\n\n        return this;\n    },\n\n    getSelection() {\n        return this.selection;\n    },\n\n    setSelection(selection) {\n\n        this.selection = selection;\n        this.selection.open();\n        return this;\n    },\n\n    removeSelection() {\n\n        this.selection.deselect();\n        this.selection = null;\n        return this;\n    },\n\n    closeAndRemoveSelection() {\n\n        this.selection.close();\n        this.removeSelection();\n        return this;\n    },\n\n    hasSelection() {\n        return this.selection !== null;\n    },\n\n    getCSRF() {\n        return this.csrf;\n    }\n});\n\nconst createSelection = (map, createMessage, properties, coordinates) => ({\n\n    map: map,\n    createMessage: createMessage,\n    properties: properties,\n    coordinates: coordinates,\n    window: null,\n\n    getCode() { return this.properties.msoa11cd; },\n    getName() { return this.properties.msoa11hclnm; },\n\n    open() {\n\n        // Highlight the selection's feature\n        this.map.setPaintProperty(\n            \"msoa-highlight\",\n            \"fill-opacity\",\n            [\"case\", [\"==\", [\"get\", \"msoa11cd\"],\n                this.properties.msoa11cd], 0.2, 0.0]);\n\n        // Open the selection window\n        this.window = new mapboxgl.Popup({closeButton: false})\n            .setLngLat(this.coordinates)\n            .setDOMContent(this.createMessage(this.properties))\n            .addTo(this.map);\n\n        this.window.on(\"close\", () => {});\n    },\n\n    close() {\n        // Close the selection window if it exists\n        if (this.window !== null) this.window.remove();\n    },\n\n    deselect() {\n        // Remove the highlight from the selection's feature\n        this.map.setPaintProperty(\"msoa-highlight\", \"fill-opacity\", 0.0);\n    }\n});\n\nconst createClickHandler = (app) => {\n\n    const createMessage = createMessageFactory(app);\n\n    return (e) => {\n\n        // Get the feature under the pointer\n        const feature = app.map.queryRenderedFeatures(\n            e.point, {layers: [\"msoa-highlight\"]})[0];\n\n        // If there is no feature under the pointer just remove the selection\n        if (feature === undefined) {\n            if (app.hasSelection()) {\n                app.removeSelection();\n            }\n            return;\n        }\n\n        // Get the area code for the feature\n        const clickedCode = feature.properties.msoa11cd;\n\n        // If the click is on an open selection, remove it\n        if (app.hasSelection() &&\n            app.selection.getCode() == clickedCode) {\n            app.removeSelection();\n            return;\n        }\n\n        // Otherwise create a new selection\n        app.setSelection(createSelection(\n            app.map, createMessage, feature.properties, e.lngLat));\n    };\n};\n\nconst createMessageFactory = (app) => {\n\n    const closeHandler = () => {\n        app.closeAndRemoveSelection();\n    };\n\n    return (properties) => {\n\n        const html = `\n            <div id=\"namebox\">\n                <p>${properties.msoa11hclnm}</p>\n            </div>\n            <div id=\"contentbox\">\n                <p>${properties.msoa11nm}</p>\n                <p>${properties.msoa11cd}</p>\n                <p>\n                    <a href=\"/msoanames/static/MSOA-Names-${app.config.msoanamesVersion}.xlsx\">Excel</a> /\n                    <a href=\"/msoanames/static/MSOA-Names-${app.config.msoanamesVersion}.csv\">CSV</a>\n                </p>\n            </div>\n            <div id=\"buttonbox\">\n                <button class=\"closebutton\" type=\"button\">Close</button>\n            </div>`;\n\n        const message = document.createElement(\"div\");\n        message.className = \"messagebox\";\n        message.innerHTML = html;\n\n        const closeButton = message.getElementsByClassName(\"closebutton\")[0];\n        closeButton.addEventListener(\"click\", closeHandler, false);\n\n        return message;\n    };\n};\n\n// Exports -------------------------------------------------------------------\nexport { createMap, createApp };\n"],"sourceRoot":""}